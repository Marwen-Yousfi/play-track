<div class="action-recorder">
  <div class="recorder-header">
    <h3>Record Action</h3>
    <div class="step-indicator">
      Step {{ currentStep() }} of {{ totalSteps() }}
    </div>
  </div>

  
  @if (currentStep() === 1) {
    <div class="step-content">
      <h4>1. Select Action Type</h4>
      <div class="form-group">
        <label for="action-select">Action</label>
        <select id="action-select" class="form-control" [ngModel]="selectedAction()" (ngModelChange)="selectAction($event)">
          <option [ngValue]="null" disabled>Select an action</option>
          @for (action of actionTypes; track action.type) {
            <option [ngValue]="action.type">{{ action.icon }} {{ action.label }}</option>
          }
        </select>
      </div>

      @if (subActionTypes().length > 0) {
        <div class="form-group">
          <label for="sub-action-select">Sub-Action</label>
          <div class="custom-dropdown">
            <button class="dropdown-toggle" (click)="toggleSubActionDropdown()">
              <span>{{ selectedSubAction() ? (subActionTypes() | find:selectedSubAction():'type')?.label : 'Select a sub-action' }}</span>
              <span>v</span>
            </button>
            @if (subActionDropdownOpen()) {
              <div class="dropdown-menu">
                @for (subAction of subActionTypes(); track subAction.type) {
                  <div
                    class="dropdown-item"
                    role="option"
                    tabindex="0"
                    [attr.aria-selected]="selectedSubAction() === subAction.type"
                    (click)="selectSubAction(subAction.type)"
                    (keydown.enter)="selectSubAction(subAction.type)"
                  >
                    <span>{{ subAction.label }}</span>
                    <span class="tooltip-icon" aria-hidden="true">
                      <i>i</i>
                      <span class="tooltip">{{ subAction.description }}</span>
                    </span>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }

      @if (subEvents().length > 0) {
        <div class="form-group">
          <label for="sub-event-select">Sub-Event</label>
          <select id="sub-event-select" class="form-control" [ngModel]="selectedSubEvent()" (ngModelChange)="selectedSubEvent.set($event)">
            <option [ngValue]="null" disabled>Select a sub-event</option>
            @for (subEvent of subEvents(); track subEvent.type) {
              <option [ngValue]="subEvent.type">{{ subEvent.label }}</option>
            }
          </select>
        </div>
      }
    </div>
  }

  
  @if (currentStep() === 2) {
    <div class="step-content">
      <h4>2. Select Player</h4>
      <div class="team-selection">
        <button 
          class="btn"
          [class.btn-primary]="selectedTeam() === 'home'"
          [class.btn-secondary]="selectedTeam() !== 'home'"
          (click)="selectedTeam.set('home')">
          Home Team
        </button>
        <button 
          class="btn"
          [class.btn-primary]="selectedTeam() === 'away'"
          [class.btn-secondary]="selectedTeam() !== 'away'"
          (click)="selectedTeam.set('away')">
          Away Team
        </button>
      </div>
      
      <div class="form-group">
        <label for="player-select">Player</label>
        <select id="player-select" class="form-control" [ngModel]="selectedPlayer()" (ngModelChange)="selectPlayer($event)">
          <option [ngValue]="null" disabled>Select a player</option>
          @for (player of filteredPlayers(); track player.id) {
            <option [ngValue]="player.id">{{ player.jerseyNumber }} - {{ player.name }}</option>
          }
        </select>
      </div>
    </div>
  }

  
  @if (currentStep() === 3) {
    <div class="step-content">
      @if (requiresDualPosition() && requiresPitchPosition()) {
        <h4>3. Click Origin Position</h4>
        <p class="instruction-text">
          Click on the field where the {{ selectedAction() }} started
        </p>
        @if (originCoordinates()) {
          <div class="coordinates-info">
            Origin position: ({{ originCoordinates()!.x.toFixed(1) }}, {{ originCoordinates()!.y.toFixed(1) }})
          </div>
        }
      } @else if (requiresDualPosition() && !requiresPitchPosition()) {
        <h4>3. Receiver / Destination</h4>
        <p class="instruction-text">
          Select receiver or click destination for the {{ selectedAction() }}
        </p>
        @if (selectedAction() === 'pass') {
          <div class="form-group">
            <label for="receiver-select">Receiver</label>
            <select id="receiver-select" class="form-control" [ngModel]="selectedReceiver()" (ngModelChange)="selectReceiver($event)">
              <option [ngValue]="null">No Receiver / Skip</option>
              @for (player of filteredPlayers(); track player.id) {
                <option [ngValue]="player.id">{{ player.jerseyNumber }} - {{ player.name }}</option>
              }
            </select>
          </div>
        } @else {
          <p class="instruction-text">Click on the field where the {{ selectedAction() }} ended</p>
          @if (destinationCoordinates()) {
            <div class="coordinates-info">Destination: ({{ destinationCoordinates()!.x.toFixed(1) }}, {{ destinationCoordinates()!.y.toFixed(1) }})</div>
          }
        }
      } @else {
        <h4>3. Click on Field to Mark Position</h4>
        <p class="instruction-text">
          Click on the football field below to mark where the action occurred
        </p>
        @if (selectedCoordinates()) {
          <div class="coordinates-info">
            Position selected: ({{ selectedCoordinates()!.x.toFixed(1) }}, {{ selectedCoordinates()!.y.toFixed(1) }})
          </div>
        }
      }
    </div>
  }

  @if (currentStep() === 4 && requiresDualPosition()) {
    <div class="step-content">
      @if (requiresDualPosition() && selectedAction() === 'pass') {
        <h4>4. Select Receiver (Optional)</h4>
        <p class="instruction-text">
          Select the player who received the pass (optional - skip if not applicable)
        </p>
        
        <div class="team-selection">
          <button 
            class="btn"
            [class.btn-primary]="selectedTeam() === 'home'"
            [class.btn-secondary]="selectedTeam() !== 'home'"
            (click)="selectedTeam.set('home')">
            Home Team
          </button>
          <button 
            class="btn"
            [class.btn-primary]="selectedTeam() === 'away'"
            [class.btn-secondary]="selectedTeam() !== 'away'"
            (click)="selectedTeam.set('away')">
            Away Team
          </button>
        </div>
        
        <div class="form-group">
          <label for="receiver-select">Receiver</label>
          <select id="receiver-select" class="form-control" [ngModel]="selectedReceiver()" (ngModelChange)="selectReceiver($event)">
            <option [ngValue]="null">No Receiver / Skip</option>
            @for (player of filteredPlayers(); track player.id) {
              <option [ngValue]="player.id">{{ player.jerseyNumber }} - {{ player.name }}</option>
            }
          </select>
        </div>
        
      } @else if (requiresDualPosition()) {
        <h4>4. Click Destination Position</h4>
        <p class="instruction-text">
          Click on the field where the {{ selectedAction() }} ended
        </p>
        @if (destinationCoordinates()) {
          <div class="coordinates-info">
            Destination: ({{ destinationCoordinates()!.x.toFixed(1) }}, {{ destinationCoordinates()!.y.toFixed(1) }})
          </div>
        }
      }
    </div>
  }

  
  @if (currentStep() === 5 && requiresDualPosition() && selectedAction() !== 'corner' && selectedAction() !== 'penalty') {
    <div class="step-content">
      <h4>5. Click Destination Position</h4>
      <p class="instruction-text">
        Click on the field where the {{ selectedAction() }} ended
      </p>
      @if (destinationCoordinates()) {
        <div class="coordinates-info">
          Destination: ({{ destinationCoordinates()!.x.toFixed(1) }}, {{ destinationCoordinates()!.y.toFixed(1) }})
        </div>
      }
    </div>
  }

  

  <!-- Navigation Buttons -->
  <div class="recorder-footer">
    @if (currentStep() > 1) {
      <button class="btn btn-secondary" (click)="previousStep()">
        Previous
      </button>
    }
    
    <div class="spacer"></div>
    
    @if (currentStep() < totalSteps()) {
      <button 
        class="btn btn-primary" 
        [disabled]="!canProceed()"
        [attr.aria-disabled]="!canProceed()"
        (click)="nextStep()">
        Next
      </button>
    } @else {
      <button 
        class="btn btn-success" 
        [disabled]="!canProceed() || !allRequiredFilled()"
        [attr.aria-disabled]="!canProceed() || !allRequiredFilled()"
        (click)="saveEvent()">
        Save Event
      </button>
    }
    
    <button class="btn btn-secondary" (click)="cancel()">
      Cancel
    </button>
  </div>
</div>
