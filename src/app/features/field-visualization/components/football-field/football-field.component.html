<div class="field-container" #fieldElement (click)="onFieldClick($event)" (mousemove)="onFieldMouseMove($event)"
    (mouseup)="onFieldMouseUp()" (mouseleave)="onFieldMouseLeave()">
    <svg class="football-field" viewBox="0 0 1050 680" [class.interactive]="interactive()">

        <!-- Field background -->
        <rect class="field-bg" x="0" y="0" width="1050" height="680" />

        <!-- Outer boundary -->
        <rect class="field-line" x="10" y="10" width="1030" height="660" fill="none" stroke="white" stroke-width="2" />

        <!-- Halfway line -->
        <line class="field-line" x1="525" y1="10" x2="525" y2="670" stroke="white" stroke-width="2" />

        <!-- Center circle -->
        <circle class="field-line" cx="525" cy="340" r="91.5" fill="none" stroke="white" stroke-width="2" />
        <circle class="field-line" cx="525" cy="340" r="2" fill="white" />

        <!-- Left penalty area -->
        <rect class="field-line" x="10" y="188.5" width="165" height="303" fill="none" stroke="white"
            stroke-width="2" />

        <!-- Left goal area -->
        <rect class="field-line" x="10" y="262.5" width="55" height="155" fill="none" stroke="white" stroke-width="2" />

        <!-- Left penalty spot -->
        <circle class="field-line" cx="121" cy="340" r="2" fill="white" />

        <!-- Left penalty arc -->
        <path class="field-line" d="M 175 249 A 91.5 91.5 0 0 1 175 431" fill="none" stroke="white" stroke-width="2" />

        <!-- Right penalty area -->
        <rect class="field-line" x="875" y="188.5" width="165" height="303" fill="none" stroke="white"
            stroke-width="2" />

        <!-- Right goal area -->
        <rect class="field-line" x="985" y="262.5" width="55" height="155" fill="none" stroke="white"
            stroke-width="2" />

        <!-- Right penalty spot -->
        <circle class="field-line" cx="929" cy="340" r="2" fill="white" />

        <!-- Right penalty arc -->
        <path class="field-line" d="M 875 249 A 91.5 91.5 0 0 0 875 431" fill="none" stroke="white" stroke-width="2" />

        <!-- Corner arcs -->
        <path class="field-line" d="M 10 20 A 10 10 0 0 1 20 10" fill="none" stroke="white" stroke-width="2" />
        <path class="field-line" d="M 1030 10 A 10 10 0 0 1 1040 20" fill="none" stroke="white" stroke-width="2" />
        <path class="field-line" d="M 1040 660 A 10 10 0 0 1 1030 670" fill="none" stroke="white" stroke-width="2" />
        <path class="field-line" d="M 20 670 A 10 10 0 0 1 10 660" fill="none" stroke="white" stroke-width="2" />

        <!-- Arrow marker definitions -->
        <defs>
            <marker id="arrowhead-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                <polygon points="0 0, 10 3, 0 6" fill="#4caf50" />
            </marker>
            <marker id="arrowhead-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                <polygon points="0 0, 10 3, 0 6" fill="#f44336" />
            </marker>
            <marker id="arrowhead-yellow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                <polygon points="0 0, 10 3, 0 6" fill="#ffc107" />
            </marker>
        </defs>

        <!-- Event arrows -->
        @for (arrow of arrows(); track $index) {
        <line [attr.x1]="arrow.from.x * 10.3" [attr.y1]="arrow.from.y * 6.7" [attr.x2]="arrow.to.x * 10.3"
            [attr.y2]="arrow.to.y * 6.7" [attr.stroke]="arrow.color" stroke-width="3"
            [attr.marker-end]="getArrowMarker(arrow.color)" opacity="0.7" class="event-arrow" />
        }

        <!-- Origin position marker (temporary during recording) -->
        @if (originPosition()) {
        <circle [attr.cx]="originPosition()!.x * 10.3" [attr.cy]="originPosition()!.y * 6.7" r="10" fill="orange"
            opacity="0.8" stroke="white" stroke-width="2" class="origin-marker">
            <animate attributeName="r" values="10;14;10" dur="1s" repeatCount="indefinite" />
        </circle>
        }

        <!-- Players -->
        @for (player of players(); track player.id) {
        <g class="player" [attr.transform]="getPlayerTransform(player)" (mousedown)="onPlayerMouseDown($event, player)"
            (click)="onPlayerClick($event, player)" [class.dragging]="draggedPlayerId() === player.id"
            style="pointer-events: all;">

            <!-- Player circle -->
            <circle [attr.r]="playerRadius"
                [attr.fill]="player.team === 'home' ? 'var(--home-team, #0d47a1)' : 'var(--away-team, #b71c1c)'"
                [attr.stroke]="player.team === 'home' ? '#0d47a1' : '#b71c1c'" stroke-width="2" class="player-circle"
                [class.selected]="selectedPlayer()?.id === player.id" style="pointer-events: all;" />

            <!-- Jersey number -->
            <text text-anchor="middle" dy="0.35em" fill="white" font-size="14" font-weight="bold" class="player-number"
                style="pointer-events: none;">
                {{ player.jerseyNumber }}
            </text>
        </g>
        }

        <!-- Click indicator -->
        @if (lastClickPosition()) {
        <circle [attr.cx]="lastClickPosition()!.x * 10.3" [attr.cy]="lastClickPosition()!.y * 6.7" r="8" fill="yellow"
            opacity="0.7" class="click-indicator">
            <animate attributeName="r" from="8" to="20" dur="0.5s" repeatCount="1" />
            <animate attributeName="opacity" from="0.7" to="0" dur="0.5s" repeatCount="1" />
        </circle>
        }
    </svg>

    @if (showCoordinates() && lastClickPosition()) {
    <div class="coordinates-display">
        Click position: ({{ lastClickPosition()!.x.toFixed(1) }}, {{ lastClickPosition()!.y.toFixed(1) }})
    </div>
    }
</div>